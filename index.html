<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Educacional 4.0</title>
    <!-- Carregamento do Tailwind CSS para estiliza√ß√£o responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o de Fonte -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #c9d1d9; /* Cor do texto claro */
            transition: opacity 0.5s ease-in-out;
        }
        .screen-container {
            display: none;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .challenge-box {
            background-color: #161b22; /* Fundo do card */
            border: 1px solid #30363d;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .btn-primary {
            background-color: #238636; /* Verde GitHub */
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #2ea043;
            transform: translateY(-1px);
        }
        .input-code {
            border: 1px solid #30363d;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }
        /* Efeito de glitch para a tela de elimina√ß√£o */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .eliminated-glitch h1 {
            animation: glitch 0.1s infinite alternate;
            text-shadow: 2px 2px #ff0000, -2px -2px #00ffff;
        }
        /* Estilos espec√≠ficos para o timer */
        #timer-display {
            background-color: #ff0000;
            color: white;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        .message-box {
            border-left: 4px solid #f0b343; /* Cor de aviso */
            background-color: #211c15;
            color: #f0b343;
        }
    </style>
</head>
<body>

    <!-- Modal para mensagens de sucesso/erro/aviso -->
    <div id="custom-modal" class="modal fixed inset-0 hidden items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-white"></h2>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close-btn" onclick="window.closeModal()" class="w-full btn-primary py-2 rounded-lg font-semibold">
                Entendido
            </button>
        </div>
    </div>

    <!-- 1. Tela Inicial -->
    <div id="start-screen" class="screen-container flex">
        <div class="text-center max-w-xl p-8 challenge-box rounded-xl">
            <h1 class="text-4xl font-extrabold mb-4 text-green-400">ESCAPE ROOM 4.0: A CHAVE DIGITAL</h1>
            <p class="text-xl mb-6">Uma jornada de conhecimento sobre Qualidade, Projetos e Ind√∫stria 4.0.</p>
            
            <div class="mb-6 p-4 rounded-lg message-box">
                <h3 class="font-bold text-lg mb-2">üö® Alerta Cr√≠tico (Anti-Cheat)</h3>
                <p class="text-sm">Esta √© uma miss√£o imersiva. **Se voc√™ sair desta p√°gina, mudar de aba ou minimizar a janela, o sistema anti-cheat o considerar√° "Eliminado"** por tentar consultar informa√ß√µes externas. Mantenha o foco aqui!</p>
            </div>

            <h3 class="text-2xl font-semibold mb-3">Selecione o N√≠vel de Dificuldade:</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="window.startGame(1)" class="btn-primary py-3 rounded-lg font-semibold">
                    Vers√£o 1: C√≥digo Zero (F√°cil)
                </button>
                <button onclick="window.startGame(2)" class="btn-primary py-3 rounded-lg font-semibold">
                    Vers√£o 2: Matriz Cr√≠tica (M√©dio)
                </button>
                <button onclick="window.startGame(3)" class="btn-primary py-3 rounded-lg font-semibold">
                    Vers√£o 3: Kernel Qu√¢ntico (Dif√≠cil)
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Tela de Desafio (Principal) -->
    <div id="game-screen" class="screen-container flex hidden">
        <div class="challenge-box p-6 md:p-10 rounded-xl w-full max-w-3xl">
            
            <!-- Barra superior: Timer e Contador de Desafios -->
            <div class="flex justify-between items-center mb-6">
                <div id="challenge-counter" class="text-xl font-bold text-gray-400"></div>
                <div id="timer-display" class="px-4 py-2 rounded-full text-xl shadow-lg">00:00:00</div>
            </div>

            <h2 id="challenge-title" class="text-3xl font-bold mb-4 text-green-400"></h2>
            <div id="challenge-story" class="mb-6 text-base leading-relaxed text-gray-300 border-l-4 border-gray-600 pl-4 py-2 bg-gray-900/50 rounded-md"></div>
            
            <!-- Descri√ß√£o do Desafio e Regra de Convers√£o -->
            <div class="space-y-4">
                <div id="challenge-description" class="text-lg font-semibold text-gray-200"></div>
                
                <div id="conversion-rule" class="p-4 rounded-lg bg-yellow-900/30 text-yellow-300 font-mono text-sm border border-yellow-800/50">
                    <p class="font-bold mb-1">REGRA DE CONVERS√ÉO (CR√çTICO!):</p>
                    <p id="conversion-text"></p>
                </div>
            </div>

            <!-- Entrada de Resposta -->
            <div class="mt-8">
                <label for="answer-input" class="block text-xl font-semibold mb-3">Insira o C√≥digo Mestre:</label>
                <input type="number" id="answer-input" class="input-code w-full p-3 rounded-lg text-2xl text-center focus:ring-green-500 focus:border-green-500" placeholder="Apenas n√∫meros">
                <button onclick="window.checkAnswer()" class="w-full mt-4 btn-primary py-3 rounded-lg font-semibold text-lg">
                    ENVIAR C√ìDIGO E AVAN√áAR
                </button>
            </div>
            
            <!-- Mensagem de feedback (sucesso/erro) -->
            <p id="feedback-message" class="mt-4 text-center text-lg font-semibold"></p>
        </div>
    </div>

    <!-- 3. Tela Final (Sucesso) -->
    <div id="finish-screen" class="screen-container flex hidden">
        <div class="text-center max-w-xl p-10 challenge-box rounded-xl">
            <h1 class="text-5xl font-extrabold mb-6 text-green-500">üèÜ MISS√ÉO CUMPRIDA! üèÜ</h1>
            <p class="text-xl mb-4 text-gray-300">A Chave Digital foi desbloqueada!</p>
            
            <div class="bg-gray-700/50 p-6 rounded-lg mb-6">
                <p class="text-2xl font-semibold text-white mb-2">Seu Tempo Final:</p>
                <p id="final-time-display" class="text-5xl font-extrabold text-yellow-400"></p>
                <p class="text-base text-gray-400 mt-2">Vers√£o: <span id="final-version"></span></p>
            </div>
            
            <div class="p-4 rounded-lg message-box mb-6">
                <h3 class="font-bold text-lg mb-2">üéâ Parab√©ns!</h3>
                <p class="text-sm">Anote o seu tempo e o seu ID de Usu√°rio (abaixo) e entregue ao professor para garantir sua posi√ß√£o no ranking!</p>
            </div>
            
            <div class="bg-gray-700/50 p-4 rounded-lg mb-8">
                <p class="text-xl font-semibold text-white mb-2">Seu ID de Usu√°rio √önico:</p>
                <div class="flex justify-center items-center space-x-2">
                    <input type="text" id="user-id-display" class="input-code p-2 rounded-lg text-lg text-center font-mono select-all w-3/4" readonly>
                    <button onclick="window.copyToClipboard('user-id-display')" class="btn-primary p-2 rounded-lg text-sm">Copiar</button>
                </div>
            </div>

            <button onclick="window.location.reload()" class="w-full btn-primary py-3 rounded-lg font-semibold text-lg">
                REINICIAR E TENTAR OUTRO N√çVEL
            </button>
        </div>
    </div>
    
    <!-- 4. Tela de Elimina√ß√£o (Anti-Cheat) -->
    <div id="eliminated-screen" class="screen-container flex hidden fixed inset-0 eliminated-glitch bg-gray-900/95">
        <div class="text-center max-w-xl p-10 challenge-box rounded-xl border-red-600 border-4">
            <h1 class="text-6xl font-extrabold text-red-500 mb-6">üö® ELIMINADO! üö®</h1>
            <p class="text-2xl mb-8 text-gray-300">Voc√™ tentou sair da √°rea de miss√£o. O sistema anti-cheat detectou uma consulta externa.</p>
            <p class="text-xl font-semibold text-red-400 mb-10">Miss√£o Falhou. Por favor, reinicie para tentar novamente.</p>
            <button onclick="window.location.reload()" class="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-lg font-semibold text-lg transition-colors">
                REINICIAR O SISTEMA
            </button>
        </div>
    </div>


    <!-- Configura√ß√£o e L√≥gica do Jogo -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis Globais (MANDAT√ìRIAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anon-user';

        let gameStarted = false;
        let startTime = 0;
        let timerInterval = null;
        let currentChallengeIndex = 0;
        let currentVersion = 0;
        let challenges = {};

        // === FIREBASE SETUP ===
        async function setupFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config not available. Running in local mode.");
                return;
            }
            try {
                // setLogLevel('debug'); // Descomentar para debug de Firestore
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('user-id-display').value = userId;
                console.log("Firebase e autentica√ß√£o configurados. User ID:", userId);
            } catch (error) {
                console.error("Erro ao configurar Firebase ou autentica√ß√£o:", error);
                // Fallback para ID an√¥nimo se o Firebase falhar
                userId = crypto.randomUUID(); 
                document.getElementById('user-id-display').value = userId;
            }
        }
        
        setupFirebase();
        
        // === DEFINI√á√ÉO DOS DESAFIOS ===
        const allChallenges = {
            1: { // Vers√£o 1: C√≥digo Zero (F√°cil)
                name: "C√≥digo Zero",
                data: [
                    { title: "Servidor Desorganizado", discipline: "Qualidade e Produtividade", 
                      story: "O servidor principal da empresa est√° com arquivos totalmente desorganizados, resultando em 30% de tempo desperdi√ßado. Voc√™ precisa aplicar o primeiro princ√≠pio de organiza√ß√£o japonesa para desbloquear o acesso.",
                      description: "Identifique o termo em japon√™s que significa 'Ordena√ß√£o' ou 'Arruma√ß√£o' (a primeira etapa do 5S) para encontrar o c√≥digo.",
                      conversion: "Converta o nome japon√™s do princ√≠pio para n√∫meros, usando a posi√ß√£o de cada letra no alfabeto (A=1, B=2, ..., Z=26). Concatene os d√≠gitos.",
                      answer: 1959189 }, // SEIRI
                    
                    { title: "O Caminho da Miss√£o", discipline: "Desenvolvimento de Projetos", 
                      story: "A equipe de projetos recebeu um pacote com quatro n√∫meros que representam as fases, fora de ordem: 1. Execu√ß√£o, 2. Planejamento, 3. Inicia√ß√£o, 4. Encerramento. Para abrir o cofre, voc√™ deve inserir os n√∫meros na ordem cronol√≥gica correta.",
                      description: "Para liberar a chave, voc√™ deve organizar os n√∫meros fornecidos seguindo a ordem correta do Ciclo de Vida do Projeto.",
                      conversion: "Com base na sua compreens√£o do ciclo de vida do projeto, concatene os n√∫meros fornecidos na tela, seguindo a ordem cronol√≥gica correta das quatro fases.",
                      answer: 3214 }, // Inicia√ß√£o(3), Planejamento(2), Execu√ß√£o(1), Encerramento(4)
                    
                    { title: "O C√©rebro das Coisas", discipline: "TI e Ind√∫stria 4.0", 
                      story: "Um sistema de monitoramento de m√°quinas foi desativado. Ele √© o pilar que permite a comunica√ß√£o entre dispositivos. O c√≥digo de reativa√ß√£o √© baseado no acr√¥nimo desse pilar. (Aten√ß√£o: acr√¥nimo em ingl√™s).",
                      description: "O c√≥digo √© a convers√£o do acr√¥nimo em ingl√™s do pilar da Ind√∫stria 4.0, a rede que conecta dispositivos f√≠sicos.",
                      conversion: "Converta o acr√¥nimo em ingl√™s (3 letras) para a posi√ß√£o de cada letra no alfabeto (A=1, B=2, ...). Concatene os d√≠gitos.",
                      answer: 91520 }, // IoT (9, 15, 20)
                    
                    { title: "O Ciclo de Melhoria", discipline: "Qualidade e Produtividade", 
                      story: "Um defeito de processo exige uma 'A√á√ÉO' imediata para evitar retrabalho. O c√≥digo de acesso ao sistema de corre√ß√£o √© baseado na contagem de letras e na posi√ß√£o desta etapa no ciclo.",
                      description: "Identifique a palavra em portugu√™s que define a quarta e √∫ltima fase do Ciclo PDCA (a etapa 'A'), respons√°vel por consolidar a melhoria.",
                      conversion: "Use o n√∫mero de letras da palavra em portugu√™s que define a etapa 'A' do PDCA. Concatene-o com o n√∫mero da sua posi√ß√£o no ciclo (1 a 4).",
                      answer: 54 }, // A√á√ÉO (5 letras), 4¬™ posi√ß√£o
                    
                    { title: "O Tri√¢ngulo de Ferro", discipline: "Desenvolvimento de Projetos", 
                      story: "Em um projeto, tr√™s fatores est√£o sempre interligados. O c√≥digo de desbloqueio est√° ligado ao fator que define 'O QU√ä' ser√° entregue, sendo o mais importante para a aceita√ß√£o do cliente.",
                      description: "Descubra o termo em portugu√™s que define 'O QU√ä' ser√° entregue e representa uma das restri√ß√µes fundamentais da Tripla Restri√ß√£o (Tempo, Custo, e X).",
                      conversion: "Converta o n√∫mero de letras da palavra (em portugu√™s) para um d√≠gito. Repita esse d√≠gito 5 vezes.",
                      answer: 66666 }, // ESCOPO (6 letras)
                    
                    { title: "As Cinco Dimens√µes", discipline: "TI e Ind√∫stria 4.0", 
                      story: "A base de dados cresceu exponencialmente, caracterizando o Big Data. O c√≥digo de acesso √© baseado nas suas dimens√µes, come√ßando com a letra 'V'.",
                      description: "Identifique a letra que representa o Big Data e as dimens√µes que se referem √† *Quantidade de Dados* e *Rapidez de Processamento*.",
                      conversion: "O c√≥digo √© a concatena√ß√£o da posi√ß√£o alfab√©tica da letra 'V' (22), seguida pelo n√∫mero de letras da palavra em portugu√™s que define a *Quantidade de Dados*, e depois pelo n√∫mero de letras da palavra que define a *Rapidez de Processamento*.",
                      answer: 22610 }, // V(22), Volume(6), Velocidade(10)
                    
                    { title: "O Diagrama Espinha de Peixe", discipline: "Qualidade e Produtividade", 
                      story: "Para analisar a causa de um problema de qualidade, a equipe usou o Diagrama de Ishikawa. O c√≥digo √© uma refer√™ncia ao n√∫mero de 'M's que iniciam as 6 categorias cl√°ssicas de an√°lise.",
                      description: "Para gerar o c√≥digo, voc√™ deve contar o total de categorias no Diagrama de Ishikawa que se iniciam com a letra 'M' (em portugu√™s).",
                      conversion: "Some o n√∫mero de 'M's que iniciam as 6 categorias cl√°ssicas. Repita o resultado duas vezes e finalize com o n√∫mero de letras da categoria 'M√£o de Obra'.",
                      answer: 663 }, // 6 M's, repetido 66, M√£o(3).
                    
                    { title: "A Janela de Oportunidade", discipline: "Desenvolvimento de Projetos", 
                      story: "A rota cr√≠tica do projeto foi calculada: A(5h) -> B(3h) -> C(7h). O c√≥digo de conclus√£o √© baseado na dura√ß√£o total dessa rota.",
                      description: "Seu objetivo √© calcular a dura√ß√£o total do Caminho Cr√≠tico (em horas) da rota A(5h) -> B(3h) -> C(7h) para encontrar o primeiro componente do c√≥digo.",
                      conversion: "O c√≥digo √© a concatena√ß√£o da dura√ß√£o total do Caminho Cr√≠tico (em horas) seguida pelo n√∫mero do desafio atual.",
                      answer: 158 } // 5+3+7=15h, desafio 8.
                ]
            },
            
            2: { // Vers√£o 2: Matriz Cr√≠tica (M√©dio)
                name: "Matriz Cr√≠tica",
                data: [
                    { title: "O Custo Oculto", discipline: "Qualidade e Produtividade", 
                      story: "Uma regra diz que a maior parte dos custos de n√£o qualidade est√° na ponta do 'iceberg' (10%). O c√≥digo de acesso √© uma combina√ß√£o desse percentual com a contagem de letras na palavra 'Qualidade'.",
                      description: "Identifique o percentual do custo de n√£o qualidade que est√° na base do 'iceberg' (a Regra do Gelo) para gerar o primeiro n√∫mero da chave.",
                      conversion: "Converta o percentual para um n√∫mero inteiro. Some o n√∫mero de 'Q's na palavra 'Qualidade' com o n√∫mero de 'N's na palavra 'N√£o Qualidade' e concatene o resultado com o n√∫mero inteiro do percentual.",
                      answer: 1023 }, // 10 (inteiro) + 2 Q's + 3 N's
                    
                    { title: "Hierarquia de Tarefas", discipline: "Desenvolvimento de Projetos", 
                      story: "A equipe precisa estruturar todas as entregas do projeto em uma hierarquia, desde o n√≠vel macro at√© as tarefas. O c√≥digo √© o acr√¥nimo em ingl√™s para essa estrutura, seguido pelo n√∫mero de n√≠veis (3) que a estrutura possui.",
                      description: "O c√≥digo √© a convers√£o do acr√¥nimo em ingl√™s para a ferramenta de decomposi√ß√£o hier√°rquica, a 'Estrutura Anal√≠tica do Projeto'.",
                      conversion: "Converta o acr√¥nimo em ingl√™s (3 letras) para a posi√ß√£o de cada letra no alfabeto. Concatene os d√≠gitos. O resultado final deve ser seguido pelo n√∫mero de n√≠veis hier√°rquicos (3).",
                      answer: 232193 }, // WBS (23, 2, 19) + 3
                    
                    { title: "O Tri√¢ngulo da Seguran√ßa", discipline: "TI e Ind√∫stria 4.0", 
                      story: "Um sistema de seguran√ßa foi bloqueado. Para restaur√°-lo, voc√™ precisa do c√≥digo baseado na tr√≠ade de princ√≠pios que garante a seguran√ßa da informa√ß√£o (a sigla internacional).",
                      description: "Para liberar o sistema, use a sigla internacional (em ingl√™s) para a Tr√≠ade da Seguran√ßa: Confidencialidade, Integridade e Disponibilidade.",
                      conversion: "Use a posi√ß√£o alfab√©tica das letras do acr√¥nimo internacional (em ingl√™s) para a tr√≠ade da seguran√ßa. Concatene os d√≠gitos.",
                      answer: 394 }, // CID (3, 9, 4)
                    
                    { title: "A Regra 80/20", discipline: "Qualidade e Produtividade", 
                      story: "O princ√≠pio de Pareto afirma que 80% dos problemas v√™m de 20% das causas. O c√≥digo de acesso √© baseado na multiplica√ß√£o dos n√∫meros da regra pelo n√∫mero total de ferramentas cl√°ssicas da qualidade (7).",
                      description: "O c√≥digo depende da multiplica√ß√£o dos dois n√∫meros que comp√µem a Regra de Pareto pelo n√∫mero total de Ferramentas Cl√°ssicas da Qualidade.",
                      conversion: "Multiplique o **maior** n√∫mero da regra e o **menor** n√∫mero da regra pelo total de ferramentas cl√°ssicas da qualidade (7) e concatene os dois resultados.",
                      answer: 560140 }, // (80*7=560), (20*7=140)
                    
                    { title: "O Risco Calculado", discipline: "Desenvolvimento de Projetos", 
                      story: "O c√°lculo de risco mostrou: Probabilidade 50%, Impacto R$ 10.000,00. O c√≥digo √© baseado no valor em centenas do risco (Probabilidade x Impacto).",
                      description: "O c√≥digo se inicia com o Valor de Risco (Probabilidade x Impacto, em R$) expresso em centenas, seguido pela contagem de letras da palavra em portugu√™s para esse conceito.",
                      conversion: "O Valor de Risco (em R$) deve ser expresso em centenas, seguido pelo n√∫mero de letras da palavra 'Risco'.",
                      answer: 505 }, // Risco=R$5000. Em centenas: 50. 5 letras.
                    
                    { title: "As Camadas da Nuvem", discipline: "TI e Ind√∫stria 4.0", 
                      story: "Os servi√ßos de computa√ß√£o em nuvem (Cloud Computing) s√£o oferecidos em tr√™s camadas principais: Software, Plataforma e Infraestrutura. O c√≥digo √© baseado no n√∫mero de letras dos acr√¥nimos das camadas de **Software** e **Infraestrutura** e na palavra 'Nuvem'.",
                      description: "O c√≥digo √© uma sequ√™ncia de contagens de letras dos acr√¥nimos de *Software como Servi√ßo* (SaaS) e *Infraestrutura como Servi√ßo* (IaaS), intercaladas com a contagem da palavra 'Nuvem'.",
                      conversion: "O c√≥digo √© a sequ√™ncia formada pelo n√∫mero de letras do acr√¥nimo de *Software como Servi√ßo*, seguido pelo n√∫mero de letras da palavra 'Nuvem', e pelo n√∫mero de letras do acr√¥nimo de *Infraestrutura como Servi√ßo*.",
                      answer: 454 }, // SaaS(4), Nuvem(5), IaaS(4)
                    
                    { title: "Meta Seis Sigma", discipline: "Qualidade e Produtividade", 
                      story: "Para alcan√ßar a excel√™ncia Seis Sigma, o DPMO (Defeitos Por Milh√£o de Oportunidades) deve ser 3,4. O c√≥digo de libera√ß√£o √© a parte inteira desse n√∫mero combinada com a contagem de letras.",
                      description: "Use a parte inteira do valor DPMO (Defeitos Por Milh√£o de Oportunidades) que define o n√≠vel de excel√™ncia Seis Sigma para iniciar o c√≥digo.",
                      conversion: "O c√≥digo √© a concatena√ß√£o da parte inteira do DPMO, seguida pelo n√∫mero de 'S's na frase 'Seis Sigma'.",
                      answer: 32 }, // DPMO (3.4) tem parte inteira 3. Seis Sigma tem 2 'S's.
                    
                    { title: "O Desempenho Or√ßament√°rio", discipline: "Desenvolvimento de Projetos", 
                      story: "O projeto teve o Custo Real (CR) de R$ 12.000,00 e o Valor Agregado (VA) de R$ 15.000,00. O c√≥digo final √© o √çndice de Desempenho de Custo (CPI).",
                      description: "O c√≥digo requer o c√°lculo do √çndice de Desempenho de Custo (CPI = VA/CR) e a combina√ß√£o desse resultado com um n√∫mero de refer√™ncia.",
                      conversion: "Calcule o CPI, arredondando para duas casas decimais (remova a v√≠rgula). Concatene este resultado com a soma dos d√≠gitos do n√∫mero 88.",
                      answer: 12516 } // CPI = 1.25 (125). 8+8=16.
                ]
            },
            
            3: { // Vers√£o 3: Kernel Qu√¢ntico (Dif√≠cil)
                name: "Kernel Qu√¢ntico",
                data: [
                    { title: "Eliminando o Desperd√≠cio", discipline: "Qualidade e Produtividade", 
                      story: "O sistema Lean busca eliminar os 7 tipos de desperd√≠cio (MUDAs). O c√≥digo de acesso √© uma combina√ß√£o da contagem de letras dos desperd√≠cios de 'Excesso de Produ√ß√£o' e 'Produtos com Falhas'.",
                      description: "Identifique as palavras em portugu√™s que definem os desperd√≠cios de 'Excesso de Produ√ß√£o' e 'Produtos com Falhas' para realizar o c√°lculo.",
                      conversion: "Some o n√∫mero de letras da palavra em portugu√™s para o Desperd√≠cio de 'Excesso de Produ√ß√£o' e o Desperd√≠cio de 'Produtos com Falhas'. Use o resultado e concatene com o n√∫mero de 'P's encontrados na palavra do primeiro desperd√≠cio.",
                      answer: 213 }, // Superprodu√ß√£o(13) + Defeitos(8) = 21. Superprodu√ß√£o tem 3 'P's.
                    
                    { title: "A Reuni√£o Di√°ria", discipline: "Desenvolvimento de Projetos", 
                      story: "O time √°gil est√° preso no 'Daily Meeting' (reuni√£o di√°ria). O c√≥digo √© a contagem de letras das duas palavras em ingl√™s que definem o termo.",
                      description: "O c√≥digo √© gerado pela contagem de letras das duas palavras em ingl√™s que definem a reuni√£o di√°ria do Scrum.",
                      conversion: "Considere o nome em ingl√™s (2 palavras) da reuni√£o di√°ria. O c√≥digo √© a concatena√ß√£o do n√∫mero de letras da primeira palavra, o n√∫mero de letras da segunda palavra, seguido pelo n√∫mero de vezes que a letra 'T' aparece nas duas palavras.",
                      answer: 583 }, // Daily(5), Meeting(8). 3 'T's.
                    
                    { title: "O Reflexo Virtual", discipline: "TI e Ind√∫stria 4.0", 
                      story: "As f√°bricas do futuro dependem de uma representa√ß√£o virtual de um objeto ou processo f√≠sico. O c√≥digo √© baseado na contagem de letras das duas palavras em ingl√™s que definem este pilar da I4.0.",
                      description: "Identifique o nome em ingl√™s (2 palavras) para o pilar 'G√™meos Digitais' e utilize a contagem de suas letras para o c√°lculo.",
                      conversion: "Considere o nome em ingl√™s (2 palavras) do pilar. O c√≥digo √© a concatena√ß√£o do n√∫mero de letras da primeira palavra, o n√∫mero de letras da segunda palavra, e, em seguida, o d√≠gito da posi√ß√£o alfab√©tica da letra inicial do nome (A=1, B=2...).",
                      answer: 7444 }, // Digital(7), Twin(4). D √© 4¬™ letra.
                    
                    { title: "Mapeando o Fluxo", discipline: "Qualidade e Produtividade", 
                      story: "Um mapa de processo est√° incompleto. Falta o s√≠mbolo que representa uma 'Decis√£o' que pode levar a caminhos alternativos. O c√≥digo √© baseado na convers√£o desta palavra.",
                      description: "O c√≥digo √© a convers√£o da palavra em portugu√™s que define o elemento de 'Decis√£o' no mapeamento de processos (BPMN).",
                      conversion: "Converta a palavra (em portugu√™s) que define o elemento de decis√£o. O c√≥digo √© a concatena√ß√£o da posi√ß√£o alfab√©tica da primeira letra, a posi√ß√£o alfab√©tica da √∫ltima letra, e a quantidade total de vogais na palavra.",
                      answer: 4154 }, // Decis√£o: D(4), O(15), 4 vogais.
                    
                    { title: "Gerenciamento de Expectativas", discipline: "Desenvolvimento de Projetos", 
                      story: "A matriz Poder/Interesse √© crucial para gerenciar as partes interessadas. O c√≥digo se refere √† estrat√©gia para o quadrante de ALTO Poder e BAIXO Interesse (os stakeholders mantidos satisfeitos).",
                      description: "O c√≥digo depende da estrat√©gia (2 palavras em portugu√™s) aplicada ao quadrante de ALTO Poder e BAIXO Interesse na Matriz de Stakeholders.",
                      conversion: "Considere a estrat√©gia (2 palavras) em portugu√™s para este quadrante. Use o n√∫mero de letras da primeira palavra, seguido pelo n√∫mero de letras da segunda palavra, e, em seguida, a posi√ß√£o do quadrante (1, 2, 3 ou 4).",
                      answer: 954 }, // Gerenciar(9), Perto(5). Quadrante 4.
                    
                    { title: "Aprendizagem Supervisionada", discipline: "TI e Ind√∫stria 4.0", 
                      story: "Um algoritmo de Machine Learning precisa de dados rotulados (etiquetados). O c√≥digo est√° no nome em ingl√™s que define esse tipo de aprendizado. (Aten√ß√£o: termo em ingl√™s, uma palavra).",
                      description: "O c√≥digo √© a contagem de letras, vogais e 'S's do termo em ingl√™s para 'Aprendizado Supervisionado' no Machine Learning.",
                      conversion: "Considere o termo em ingl√™s (1 palavra) para este tipo de Aprendizado. Concatene: o total de letras, o total de vogais e o total de 'S's encontrados na palavra.",
                      answer: 1043 }, // Supervised (10), 4 vogais, 3 'S's.
                    
                    { title: "A Estrutura Unificada", discipline: "Qualidade e Produtividade", 
                      story: "As novas normas ISO (ex: 9001) usam uma estrutura de alto n√≠vel para padroniza√ß√£o de sistemas de gest√£o. O c√≥digo √© baseado no nome em ingl√™s desta estrutura (HLS).",
                      description: "Para gerar o c√≥digo, utilize o nome completo em ingl√™s (3 palavras) da 'Estrutura de Alto N√≠vel' (HLS) utilizada nas normas ISO.",
                      conversion: "Considere o nome em ingl√™s da estrutura (3 palavras). Some o n√∫mero de letras das tr√™s palavras. Multiplique o resultado por 2 e concatene com o n√∫mero de 'S's encontrados na frase.",
                      answer: 362 }, // High Level Structure (18 letras). 18*2=36. 2 'S's.
                    
                    { title: "O √öltimo Pilar", discipline: "TI e Desenvolvimento de Projetos", 
                      story: "A fus√£o de sistemas f√≠sicos e virtuais √© a chave para o projeto. O c√≥digo √© a contagem de letras das tr√™s palavras em ingl√™s que definem este pilar fundamental da I4.0.",
                      description: "O c√≥digo √© a soma do n√∫mero de letras das tr√™s palavras em ingl√™s que definem os 'Sistemas Cibern√©tico-F√≠sicos', repetida duas vezes.",
                      conversion: "Considere o nome em ingl√™s (3 palavras) do pilar. Some o n√∫mero de letras das tr√™s palavras. Repita o resultado desta soma duas vezes.",
                      answer: 2020 } // Cyber(5) + Physical(8) + Systems(7) = 20. Repetindo: 2020.
                ]
            }
        };

        // === FUN√á√ïES DE CONTROLE DE FLUXO ===

        // Fun√ß√£o para mostrar um tela e esconder as outras
        function showScreen(id) {
            document.querySelectorAll('.screen-container').forEach(screen => {
                screen.style.display = 'none';
            });
            const screen = document.getElementById(id);
            if (screen) {
                screen.style.display = 'flex';
            }
        }

        // Inicia o Jogo
        window.startGame = (version) => {
            currentVersion = version;
            challenges = allChallenges[version].data;
            currentChallengeIndex = 0;
            gameStarted = true;
            startTime = Date.now();
            
            startTimer();
            loadChallenge();
            showScreen('game-screen');
            document.getElementById('answer-input').focus();
        };

        // Carrega o desafio atual
        function loadChallenge() {
            if (currentChallengeIndex >= challenges.length) {
                return finishGame();
            }

            const challenge = challenges[currentChallengeIndex];
            
            document.getElementById('challenge-counter').textContent = `Desafio ${currentChallengeIndex + 1} de ${challenges.length} (Vers√£o ${currentVersion}: ${allChallenges[currentVersion].name})`;
            document.getElementById('challenge-title').textContent = challenge.title;
            document.getElementById('challenge-story').innerHTML = `
                <p class="font-semibold text-white mb-2">${challenge.discipline}</p>
                ${challenge.story}
            `;
            document.getElementById('challenge-description').textContent = challenge.description;
            document.getElementById('conversion-text').textContent = challenge.conversion;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback-message').textContent = '';
        }

        // Verifica a resposta do usu√°rio
        window.checkAnswer = () => {
            const inputElement = document.getElementById('answer-input');
            const feedbackElement = document.getElementById('feedback-message');
            const userAnswer = parseInt(inputElement.value.trim(), 10);
            const correctAnswer = challenges[currentChallengeIndex].answer;
            
            feedbackElement.style.color = 'white';

            if (isNaN(userAnswer) || inputElement.value.trim() === '') {
                feedbackElement.textContent = "Por favor, insira uma sequ√™ncia num√©rica v√°lida.";
                feedbackElement.style.color = '#f0b343'; // Amarelo
                return;
            }

            if (userAnswer === correctAnswer) {
                feedbackElement.textContent = "üîë C√≥digo Correto! Avan√ßando para o pr√≥ximo desafio...";
                feedbackElement.style.color = '#34d399'; // Verde
                currentChallengeIndex++;
                
                setTimeout(() => {
                    loadChallenge();
                }, 1000); // Pequeno atraso para feedback
            } else {
                feedbackElement.textContent = "üö´ C√≥digo Incorreto. Tente novamente.";
                feedbackElement.style.color = '#f87171'; // Vermelho
            }
        };

        // Finaliza o Jogo
        async function finishGame() {
            gameStarted = false;
            clearInterval(timerInterval);
            const totalTime = Date.now() - startTime;
            const finalTimeFormatted = formatTime(totalTime);
            
            document.getElementById('final-time-display').textContent = finalTimeFormatted;
            document.getElementById('final-version').textContent = `${currentVersion}: ${allChallenges[currentVersion].name}`;
            
            // Salvar resultado no Firestore
            if (db) {
                const resultsCollection = collection(db, `artifacts/${appId}/public/data/escape_room_results`);
                try {
                    await addDoc(resultsCollection, {
                        userId: userId,
                        version: currentVersion,
                        versionName: allChallenges[currentVersion].name,
                        timeMs: totalTime,
                        timeFormatted: finalTimeFormatted,
                        timestamp: serverTimestamp()
                    });
                    console.log("Resultado salvo com sucesso no Firestore.");
                } catch (e) {
                    console.error("Erro ao salvar resultado no Firestore:", e);
                }
            }
            
            showScreen('finish-screen');
        }

        // === FUN√á√ïES DE TIMER E UTILIDADE ===

        // Inicia/Continua o cron√¥metro
        function startTimer() {
            if (timerInterval) return; // Evita iniciar m√∫ltiplas vezes
            
            timerInterval = setInterval(() => {
                if (gameStarted) {
                    const elapsed = Date.now() - startTime;
                    document.getElementById('timer-display').textContent = formatTime(elapsed);
                }
            }, 1000);
        }

        // Formata o tempo em milissegundos para HH:MM:SS
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // Anti-Cheat: Elimina o jogador
        function eliminatePlayer() {
            if (!gameStarted) return;
            gameStarted = false;
            clearInterval(timerInterval);
            showScreen('eliminated-screen');
        }

        // Adiciona o listener para o anti-cheat
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && gameStarted) {
                eliminatePlayer();
            }
        });

        // Modal Customizado
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal').classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');
        };

        // Copiar para a √°rea de transfer√™ncia
        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            try {
                // Comando de c√≥pia mais compat√≠vel com iFrames
                document.execCommand('copy');
                window.showModal("Copiado!", "Seu ID de Usu√°rio foi copiado para a √°rea de transfer√™ncia.");
            } catch (err) {
                window.showModal("Erro ao Copiar", "Falha ao copiar o ID. Por favor, anote-o manualmente.");
            }
        }

        // Inicia na tela inicial
        showScreen('start-screen');

    </script>
</body>
</html>
